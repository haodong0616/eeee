# 订单状态说明

## 订单状态类型

交易所支持以下订单状态：

### 1. pending（待成交）
- **说明**：订单已创建，等待撮合
- **可操作**：可以取消
- **颜色**：蓝色

### 2. partial（部分成交）
- **说明**：订单部分成交，还有剩余未成交
- **可操作**：可以继续等待成交或取消
- **颜色**：黄色

### 3. filled（完全成交）
- **说明**：订单全部成交完毕
- **可操作**：无法取消
- **颜色**：绿色

### 4. cancelled（已取消）
- **说明**：订单被用户取消，且未有任何成交
- **可操作**：无
- **颜色**：灰色

### 5. partial_cancelled（部分成交后取消）⭐ 新增
- **说明**：订单部分成交后，用户取消了剩余部分
- **成交部分**：已完成，不可撤销
- **未成交部分**：已取消，资金已解冻
- **可操作**：无
- **颜色**：橙色

## 状态转换流程

```
pending (待成交)
    ↓
    ├─→ 全部成交 → filled (完全成交)
    ├─→ 部分成交 → partial (部分成交)
    │                  ↓
    │                  ├─→ 继续成交 → filled (完全成交)
    │                  └─→ 用户取消 → partial_cancelled (部分成交后取消)
    └─→ 用户取消 → cancelled (已取消)
```

## 取消订单的处理逻辑

### 完全未成交的订单
```
原订单：买入 1 BTC @ 65,000 USDT
已成交：0 BTC
冻结资金：65,000 USDT

用户取消后：
- 状态：cancelled
- 解冻：65,000 USDT（全部退回）
- 获得：0（没有成交）
```

### 部分成交的订单
```
原订单：买入 1 BTC @ 65,000 USDT
已成交：0.3 BTC
冻结资金：65,000 USDT（下单时冻结）
已获得：0.3 BTC（扣除手续费）

用户取消后：
- 状态：partial_cancelled ⭐
- 解冻：45,500 USDT（剩余0.7 BTC对应的资金）
- 保留：0.3 BTC（已成交部分）
- 总结：用户花了19,500 USDT买到了0.3 BTC
```

## 前端显示

### 当前委托页面
部分成交的订单会显示进度：
```
数量：1.0000
已成交：0.3000  (30%)
状态：部分成交（黄色）
操作：[取消] 按钮可用
```

点击取消后：
```
数量：1.0000
已成交：0.3000  (30%)
状态：部分成交已取消（橙色）
操作：无
```

### 历史委托页面
会显示完整的成交信息：
```
订单 #12345
买入 BTC/USDT
价格：65,000
数量：1.0000
已成交：0.3000
状态：部分成交已取消
时间：2025-10-16 14:30:00
```

## 资金流转示例

### 买单（限价 1 BTC @ 65,000 USDT）

**下单时**：
```
冻结：65,000 USDT
可用：减少 65,000 USDT
```

**成交 0.3 BTC 后**：
```
获得：0.3 BTC（扣除手续费后）
冻结：还剩 45,500 USDT（0.7 BTC 的资金）
```

**取消剩余订单**：
```
解冻：45,500 USDT
可用：增加 45,500 USDT
最终：
  - 花费：19,500 USDT
  - 获得：0.3 BTC
  - 退回：45,500 USDT
```

### 卖单（限价 1 BTC @ 65,000 USDT）

**下单时**：
```
冻结：1 BTC
可用：减少 1 BTC
```

**成交 0.3 BTC 后**：
```
获得：19,500 USDT（扣除手续费后）
冻结：还剩 0.7 BTC
```

**取消剩余订单**：
```
解冻：0.7 BTC
可用：增加 0.7 BTC
最终：
  - 卖出：0.3 BTC
  - 获得：19,500 USDT
  - 退回：0.7 BTC
```

## 重要特性

✅ **已成交部分不可撤销** - 成交即确定  
✅ **未成交部分可取消** - 资金立即解冻  
✅ **状态清晰区分** - 5种状态精确描述  
✅ **资金安全** - 所有操作可追溯  

## 代码实现

### 后端关键代码

```go
// 计算剩余未成交数量
remaining := order.Quantity.Sub(order.FilledQty)

// 只解冻未成交部分的资金
if order.Side == "buy" {
    amount := order.Price.Mul(remaining)  // 只计算剩余部分
    balance.Available = balance.Available.Add(amount)
    balance.Frozen = balance.Frozen.Sub(amount)
}

// 根据成交情况设置状态
if order.FilledQty.GreaterThan(decimal.Zero) {
    order.Status = "partial_cancelled"  // 有成交
} else {
    order.Status = "cancelled"  // 完全没成交
}
```

## 查询示例

### 查看部分成交后取消的订单
```sql
SELECT * FROM orders WHERE status = 'partial_cancelled';
```

### 统计用户的订单情况
```sql
SELECT 
    status,
    COUNT(*) as count,
    SUM(CAST(filled_qty as REAL)) as total_filled
FROM orders 
WHERE user_id = 1
GROUP BY status;
```

## 用户界面提示

当用户要取消部分成交的订单时，可以显示确认提示：

```
确认取消订单？

订单信息：
买入 1.0000 BTC @ 65,000 USDT
已成交：0.3000 BTC
未成交：0.7000 BTC

取消后：
- 保留已成交的 0.3 BTC
- 退回 45,500 USDT (0.7 BTC 的资金)

[确认取消] [继续等待]
```

## 最佳实践

1. **明确告知用户** - 取消时说明已成交部分保留
2. **显示详细信息** - 展示成交数量和取消数量
3. **状态区分** - 使用不同颜色标识
4. **历史记录** - 完整保存取消记录

这样用户就能清楚知道：
- 已经成交的部分是安全的
- 只有未成交的部分会被取消
- 资金会按实际情况解冻

后端逻辑已经是正确的了！只是现在状态显示更清晰了。✅


