# 市场模拟器系统

## 功能说明

市场模拟器系统包含两个核心组件，让交易所在没有真实交易的情况下也能展示完整的市场数据：

1. **价格模拟器** - 自动生成成交记录，模拟价格波动
2. **订单簿模拟器** - 自动挂买卖单，模拟盘口深度

## 两大模拟系统

### 1. 价格模拟器（TrendSimulator）
**作用**：生成成交记录，模拟真实交易

- 每3秒生成一次虚拟成交
- 模拟真实市场趋势（上涨/下跌/震荡）
- 每30秒可能改变趋势
- 价格波动更自然
- 交易量随波动性变化
- 通过 WebSocket 实时推送

**效果**：
- ✅ 最近成交不断滚动
- ✅ K线图持续更新
- ✅ 价格实时跳动
- ✅ 24h涨跌动态变化

### 2. 订单簿模拟器（OrderBookSimulator）⭐ 新增
**作用**：自动挂买卖单，模拟盘口深度

- 每10秒维护订单簿
- 在当前价 ±3% 范围内挂单
- 10档买单 + 10档卖单
- 距离当前价越远数量越大
- 定期刷新订单保持活跃

**效果**：
- ✅ 盘口有充足深度
- ✅ 买卖盘看起来真实
- ✅ 用户订单可以立即成交
- ✅ 降低滑点

## 启用模拟器

### 方法 1：环境变量（推荐）

编辑 `backend/.env` 文件：
```env
ENABLE_SIMULATOR=true
```

然后启动后端：
```bash
cd backend
go run main.go
```

### 方法 2：在代码中直接启用

编辑 `backend/main.go`，取消注释相关代码。

## 模拟器特性

### 价格行为

1. **趋势系统**
   - 上涨趋势：价格倾向上涨
   - 下跌趋势：价格倾向下跌
   - 震荡趋势：价格随机波动
   - 趋势每30秒随机改变

2. **价格边界**
   - 最低价：基准价 × 0.85
   - 最高价：基准价 × 1.15
   - 触及边界时自动反转趋势

3. **自然波动**
   - 随机变化：±0.5%
   - 趋势影响：±0.3%
   - 总变化：-0.8% 到 +0.8%

### 交易量

交易量随价格波动性增加：
- BTC/USDT: 0.05 - 0.5 BTC
- ETH/USDT: 1 - 10 ETH
- BNB/USDT: 10 - 100 BNB
- SOL/USDT: 25 - 250 SOL
- XRP/USDT: 500 - 5000 XRP

### 实时推送

通过 WebSocket 实时推送：
- 最新成交价格
- 成交数量
- 价格变化百分比
- 成交时间

## 效果演示

启用模拟器后，你会看到：

✅ **首页**
- 交易对价格实时变化
- 24h涨跌幅动态更新
- 成交量持续增长

✅ **行情页面**
- 所有交易对价格跳动
- 涨跌颜色变化
- 行情排序动态变化

✅ **交易页面**
- **盘口深度** 📊
  - 10档买单（绿色）
  - 10档卖单（红色）
  - 价格从紧到松分布
  - 数量从小到大递增
- **K线图** 📈
  - 持续更新
  - 支持秒级、分钟级、小时级
- **最近成交** 💹
  - 不断滚动刷新
  - 实时价格跳动
- **下单功能** ✅
  - 可以立即与虚拟订单成交
  - 真实的交易体验

## 日志输出

启用后会看到类似日志：

```
🎮 启用市场模拟器
📈 趋势模拟器已启动
📚 订单簿模拟器已启动
✅ 创建虚拟用户并充值
📚 BTC/USDT 订单簿已更新 (买单x10, 卖单x10)
📚 ETH/USDT 订单簿已更新 (买单x10, 卖单x10)
🔄 BTC/USDT 趋势变化: 上涨 (0.65)
💹 模拟交易: BTC/USDT @ $65234.50 x 0.1234
```

## 配置选项

可以在 `simulator/market.go` 中调整：

### 交易频率
```go
ticker := time.NewTicker(3 * time.Second) // 改为1秒更频繁
```

### 趋势变化频率
```go
ticker := time.NewTicker(30 * time.Second) // 改为60秒更稳定
```

### 价格波动范围
```go
randomChange := (rand.Float64() - 0.5) * 0.005 // 改为0.01增加波动
```

### 价格边界
```go
minPrice := basePrice * 0.85 // 改为0.9减小波动范围
maxPrice := basePrice * 1.15 // 改为1.1减小波动范围
```

## 使用场景

### 开发环境 ✅
- 测试前端实时数据更新
- 验证 WebSocket 推送
- 调试 K线生成
- 演示交易所功能

### 演示环境 ✅
- 产品展示
- 投资者演示
- 功能演示视频
- 用户培训

### 生产环境 ⚠️
**不推荐！** 生产环境应使用真实交易数据。

## 关闭模拟器

### 方法 1：环境变量
```env
ENABLE_SIMULATOR=false
```
或删除这一行，然后重启后端。

### 方法 2：清理模拟数据

删除所有虚拟交易记录：
```bash
cd backend
sqlite3 expchange.db

DELETE FROM trades WHERE buy_order_id = 0 AND sell_order_id = 0;
.exit
```

## 与真实交易共存

模拟器可以与真实交易同时运行：
- 虚拟交易：order_id = 0
- 真实交易：order_id > 0

查询时可以区分：
```sql
-- 只查真实交易
SELECT * FROM trades WHERE buy_order_id > 0;

-- 只查虚拟交易
SELECT * FROM trades WHERE buy_order_id = 0;
```

## 性能影响

- CPU：很低（每3秒一次计算）
- 内存：很低（只保存交易记录）
- 数据库：每3秒写入5条记录
- WebSocket：实时推送数据

### 优化建议

如果需要更高频率：
1. 增加交易频率
2. 添加更多交易对
3. 使用 Redis 缓存
4. 批量写入数据库

## 高级功能

### 1. 多种市场状态
```go
// 可以扩展为：
type MarketState int
const (
    Bull    MarketState = iota // 牛市
    Bear                        // 熊市
    Sideways                    // 横盘
    Volatile                    // 剧烈波动
)
```

### 2. 事件驱动
```go
// 添加突发事件：
- 大涨：某个时间点突然上涨5%
- 大跌：某个时间点突然下跌5%
- 爆量：交易量突然增加10倍
```

### 3. 关联性
```go
// BTC涨，其他币也倾向上涨
if btcChange > 0 {
    ethChange *= 0.8 // ETH跟随BTC 80%的涨幅
}
```

## 故障排查

### 问题：价格不变化
**检查**：
1. 环境变量是否设置
2. 后端日志是否有模拟器启动消息
3. 数据库是否有新的 trades 记录

### 问题：前端没更新
**检查**：
1. WebSocket 连接是否正常
2. 浏览器控制台是否有错误
3. 刷新页面

### 问题：价格变化太快
**解决**：
```go
// 减小波动或降低频率
ticker := time.NewTicker(10 * time.Second)
```

## 总结

市场模拟器是一个强大的工具，适合：
- 🧪 开发测试
- 🎬 功能演示
- 📚 用户培训
- 🔍 性能测试

但记住：**生产环境必须使用真实交易数据！**

